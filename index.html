<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Agent Builder</title>
<style>
  :root{--bg:#0b0c10;--card:#141824;--ink:#e9edf1;--muted:#9aa6b2;--accent:#5eead4;--line:#232735}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:900px;margin:48px auto;padding:0 20px}
  h1{margin:0 0 6px;font-size:28px}
  p.muted{margin:0 0 20px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin:12px 0 6px}
  select,textarea,input{width:100%;background:#0f1218;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  textarea{min-height:200px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px}
  .btnbar{display:flex;gap:12px;align-items:center;margin-top:14px}
  button{background:#1f2937;border:1px solid var(--line);color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);color:#0b0c10;border:none;font-weight:700}
  .hint{color:var(--muted);font-size:13px;margin-left:6px}
  .ok{color:#66ffb7}.err{color:#ff9aa8}
  .kbd{background:#0f1218;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  small.badge{background:#0f1218;border:1px solid var(--line);border-radius:8px;padding:2px 6px;margin-left:6px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Agent Builder <small class="badge" id="loadedCount"></small></h1>
  <p class="muted">Pick a scenario by <strong>scenario_id</strong>. We auto-select a recommended channel (you can change it).</p>

  <div class="card">
    <div class="row">
      <div>
        <label for="scenario">Scenario (shows <code>scenario_id</code>)</label>
        <select id="scenario"></select>
      </div>
      <div>
        <label for="channel">Channel (auto-recommended)</label>
        <select id="channel">
          <option value="email">Email</option>
          <option value="sms">SMS (Twilio)</option>
          <option value="whatsapp">WhatsApp (Twilio)</option>
          <option value="call">Voice Call (Twilio TTS)</option>
        </select>
      </div>
    </div>

    <label for="search">Search by <code>scenario_id</code></label>
    <input id="search" list="scenarioIds" placeholder="e.g. tier1_dso_SCHEDULING_NO_SHOWS" />
    <datalist id="scenarioIds"></datalist>

    <label for="bp">Blueprint (human-readable YAML; request always uses the generated YAML)</label>
    <textarea id="bp" spellcheck="false"></textarea>

    <div class="btnbar">
      <button id="build" class="primary">Build</button>
      <span id="status" class="hint"></span>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  const statusEl = $('status');
  const scenarioSel = $('scenario');
  const channelSel = $('channel');
  const searchEl = $('search');
  const bpTA = $('bp');
  const datalist = $('scenarioIds');
  const loadedCount = $('loadedCount');

  let ALL = [];
  let MAP_BY_ID = {};

  const listify = (v) => Array.isArray(v) ? v : String(v || '').split(/[;,|\s]+/).map(x=>x.trim()).filter(Boolean);

  function recommendedChannel(row) {
    const shapes = listify(row.best_reply_shapes || row.channel);
    const norm = shapes.map(s => s.toLowerCase());
    const set = new Set(norm.map(s =>
      s.includes('whatsapp') ? 'whatsapp' :
      s.includes('sms') || s.includes('text') ? 'sms' :
      s.includes('voice') || s.includes('call') || s.includes('phone') ? 'call' :
      s.includes('email') || s.includes('mail') ? 'email' : s
    ));
    if (set.has('sms')) return 'sms';
    if (set.has('whatsapp')) return 'whatsapp';
    if (set.has('email')) return 'email';
    if (set.has('call')) return 'call';
    const hay = ((row.name || '') + ' ' + (row.tags || []).join(' ')).toLowerCase();
    if (hay.includes('schedule') || hay.includes('appointment') || hay.includes('no-show')) return 'sms';
    return 'email';
  }

  function makeYaml(s) {
    const br = (v) => (v==null || String(v).trim()==='' ? '' : String(v));
    const brList = (arr) => `[${listify(arr).join(', ')}]`;
    return `version: 0.1
scenario_id: ${s.scenario_id}
name: ${br(s.name)}
agent_name: ${br(s.agent_name || 'Agent')}
best_reply_shapes: ${brList(s.best_reply_shapes)}
triggers: >${br('\\n  ' + (s.triggers || ''))}
how_it_works: >${br('\\n  ' + (s.how_it_works || ''))}
tool_stack_dev: >${br('\\n  ' + (s.tool_stack_dev || 'n8n; SMTP; Twilio'))}
roi_hypothesis: >${br('\\n  ' + (s.roi_hypothesis || ''))}
tags: [${listify(s.tags).join(', ')}]`;
  }

  function populateUI(list) {
    scenarioSel.innerHTML = '';
    list.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.scenario_id;
      opt.textContent = s.scenario_id;     // show ID
      opt.title = s.name || s.scenario_id; // human name on hover
      scenarioSel.appendChild(opt);
    });
    datalist.innerHTML = '';
    ALL.forEach(s => {
      const o = document.createElement('option');
      o.value = s.scenario_id;
      o.label = s.name || s.scenario_id;
      datalist.appendChild(o);
    });
    loadedCount.textContent = `Loaded ${ALL.length}`;
    if (list.length) applyScenario(list[0].scenario_id);
  }

  function applyScenario(id) {
    const s = MAP_BY_ID[id] || ALL.find(x => x.scenario_id === id);
    if (!s) return;
    scenarioSel.value = s.scenario_id;
    bpTA.value = makeYaml(s);
    channelSel.value = recommendedChannel(s);
  }

  async function fetchScenarios() {
    try {
      const res = await fetch('/api/scenarios');
      if (!res.ok) throw new Error('Failed to load scenarios');
      const data = await res.json();
      ALL = (data.items || []).map(x => ({
        ...x,
        best_reply_shapes: listify(x.best_reply_shapes),
        tags: listify(x.tags),
      }));
      MAP_BY_ID = Object.fromEntries(ALL.map(x => [x.scenario_id, x]));
      populateUI(ALL);
    } catch (e) {
      console.error(e);
      statusEl.textContent = '✗ Error: Failed to load scenarios'; statusEl.className = 'hint err';
      const fallback = {
        scenario_id: 'tier1_dso_SCHEDULING_NO_SHOWS',
        name: 'DSO – Scheduling (reduce no-shows)',
        agent_name: 'Scheduling Agent',
        best_reply_shapes: ['sms','email'],
        triggers: 'Regional dental groups operate 5–15 clinics. High no-show rates.',
      };
      ALL = [fallback]; MAP_BY_ID = { [fallback.scenario_id]: fallback };
      populateUI(ALL);
    }
  }

  scenarioSel.addEventListener('change', () => applyScenario(scenarioSel.value));
  searchEl.addEventListener('change', () => {
    const id = searchEl.value.trim();
    if (MAP_BY_ID[id]) applyScenario(id);
  });

  async function postBuild(body) {
    for (const path of ['/api/build', '/api/compile']) {
      const res = await fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(body)
      });
      if (res.ok) return res;
      if (res.status !== 404) {
        const txt = await res.text().catch(()=> '');
        throw new Error(`Build failed (${res.status}): ${txt || res.statusText}`);
      }
    }
    throw new Error('No build endpoint found.');
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  }

  // CLICK: always send YAML string + top-level scenario_id
  $('build').addEventListener('click', async () => {
    statusEl.textContent = 'Building…'; statusEl.className = 'hint';

    const sid = (scenarioSel.value || '').trim();
    const s = MAP_BY_ID[sid];
    if (!s) {
      statusEl.textContent = '✗ No scenario selected'; statusEl.className = 'hint err';
      return;
    }

    // Generate YAML fresh from the selected scenario (don’t rely on textarea)
    const yaml = makeYaml(s);
    bpTA.value = yaml; // keep UI in sync

    const body = {
      // Many backends expect this to be a string containing YAML or JSON
      blueprint: yaml,
      // Some parsers check top-level scenario_id too — send it explicitly
      scenario_id: s.scenario_id,
      options: {
        channel: channelSel.value,
        reply_mode: 'none',
        demoMode: false,
        overrideTo: 'kevanm.spain@gmail.com',
        overrideToPhone: '+34XXXXXXXXX',
        twilio: {
          fromSms: '+13412184164',
          fromWhatsApp: 'whatsapp:+14155238886',
          fromVoice: '+13412184164'
        }
      }
    };

    try {
      const res = await postBuild(body);
      const ct  = (res.headers.get('content-type') || '').toLowerCase();
      const buf = await res.arrayBuffer();
      const blob = new Blob([buf], { type: ct || 'application/json' });
      const name = ct.includes('zip') ? 'agent.zip' : `${sid}-workflow.json`;
      downloadBlob(blob, name);
      statusEl.textContent = `✓ Downloaded ${name}`; statusEl.className = 'hint ok';
    } catch (err) {
      console.error(err);
      statusEl.textContent = `✗ ${err.message}`; statusEl.className = 'hint err';
    }
  });

  fetchScenarios();
</script>
</body>
</html>
