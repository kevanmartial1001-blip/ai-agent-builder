<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Agent Builder — Safe Mode</title>
<style>
  :root{--bg:#0b0c10;--card:#141824;--ink:#e9edf1;--muted:#9aa6b2;--accent:#5eead4;--line:#232735;--err:#ff9aa8;--ok:#66ffb7}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:32px auto;padding:0 20px}
  h1{margin:0 0 6px;font-size:26px}
  .status{margin:12px 0 20px;padding:10px 12px;border-radius:10px;background:#0f1218;border:1px solid var(--line);display:flex;justify-content:space-between;gap:12px;align-items:center}
  .status .ok{color:var(--ok)} .status .err{color:var(--err)} .status small{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin:12px 0 6px}
  select,textarea,input,button{width:100%;background:#0f1218;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  textarea{min-height:160px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px}
  button{cursor:pointer} .primary{background:var(--accent);color:#0b0c10;border:none;font-weight:700}
  .hint{color:var(--muted);font-size:13px}
  /* suggestions */
  #suggestions{position:relative}
  .suggest-box{position:absolute;left:0;right:0;background:#0f1218;border:1px solid var(--line);border-radius:10px;margin-top:6px;max-height:260px;overflow:auto;z-index:10}
  .suggest-item{padding:8px 10px;cursor:pointer;display:flex;gap:8px;align-items:baseline}
  .suggest-item:hover{background:#121826}
  .suggest-id{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
  .suggest-name{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* debug */
  pre{white-space:pre-wrap;word-break:break-word;background:#0f1218;border:1px solid var(--line);border-radius:10px;padding:10px 12px;max-height:200px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Agent Builder <small id="counts" class="hint"></small></h1>

  <div class="status" id="statusBar">
    <span id="statusText">Loading…</span>
    <small id="statusSub"></small>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label for="scenario">Scenario (<code>scenario_id</code>)</label>
        <select id="scenario"></select>
      </div>
      <div>
        <label for="channel">Channel (auto)</label>
        <select id="channel">
          <option value="email">Email</option>
          <option value="sms">SMS (Twilio)</option>
          <option value="whatsapp">WhatsApp (Twilio)</option>
          <option value="call">Voice Call (Twilio)</option>
        </select>
      </div>
    </div>

    <label for="search">Search by <code>scenario_id</code></label>
    <input id="search" placeholder="e.g. tier1_dso_SCHEDULING_NO_SHOWS" autocomplete="off" />
    <div id="suggestions"></div>

    <label for="bp">Preview (sheet + industry)</label>
    <textarea id="bp" spellcheck="false" readonly></textarea>

    <div class="row" style="margin-top:10px">
      <button id="build" class="primary">Download n8n JSON</button>
      <div class="hint" id="buildHint">Imports directly in n8n</div>
    </div>
  </div>

  <div class="card">
    <strong>Debug</strong>
    <div class="row" style="margin-top:8px">
      <button id="pingScenarios">Ping /api/scenarios</button>
      <button id="pingIndustries">Ping /api/industries</button>
    </div>
    <pre id="debugOut" style="margin-top:10px"></pre>
  </div>
</div>

<script>
/* ===== State & helpers ===== */
const $ = id => document.getElementById(id);
const statusBar = $('statusBar'), statusText = $('statusText'), statusSub = $('statusSub'), countsEl = $('counts');
const scenarioSel = $('scenario'), channelSel = $('channel'), searchEl = $('search'), suggestWrap = $('suggestions'), bpTA = $('bp'), debugOut = $('debugOut');

let ALL = [], MAP = {};
let INDUSTRIES = [], IND_MAP = {};

const listify = v => Array.isArray(v) ? v : String(v || '').split(/[;,|\n|\|]+/).map(x=>x.trim()).filter(Boolean);
const norm = t => (t || '').toLowerCase();
const wants = (t, ...words) => { t = norm(t); return words.some(w => t.includes(w)); };

function setStatus(text, sub='', ok=false, err=false){
  statusText.textContent = text;
  statusSub.textContent = sub;
  statusText.className = ok ? 'ok' : err ? 'err' : '';
}

/* ===== API ===== */
async function getJSON(url){
  const r = await fetch(url);
  const text = await r.text();
  try { return { ok:r.ok, status:r.status, json: JSON.parse(text), raw:text }; }
  catch { return { ok:r.ok, status:r.status, json:null, raw:text }; }
}

/* ===== Channel recommendation ===== */
function recommendedChannel(row) {
  const shapes = listify(row.best_reply_shapes);
  const normed = shapes.map(s => s.toLowerCase());
  const set = new Set(normed.map(s =>
    s.includes('whatsapp') ? 'whatsapp' :
    s.includes('sms') || s.includes('text') ? 'sms' :
    s.includes('voice') || s.includes('call') || s.includes('phone') ? 'call' :
    s.includes('email') || s.includes('mail') ? 'email' : s
  ));
  if (set.has('sms')) return 'sms';
  if (set.has('whatsapp')) return 'whatsapp';
  if (set.has('email')) return 'email';
  if (set.has('call')) return 'call';
  const hay = ((row.name || '') + ' ' + (row.tags || []).join(' ')).toLowerCase();
  if (hay.includes('schedule') || hay.includes('appointment') || hay.includes('no-show')) return 'sms';
  return 'email';
}

/* ===== Industry match & preview ===== */
function matchIndustryForScenario(s) {
  const key = norm(s.name || '');
  return IND_MAP[key] || null;
}
function previewYaml(s, industry) {
  const br = v => (v==null || String(v).trim()==='' ? '' : String(v));
  const brList = arr => `[${listify(arr).join(', ')}]`;
  const ind = industry ? `
industry_id: ${industry.industry_id}
industry_painpoints: ${br((industry.painpoints||''))}
industry_channels: ${br((industry.channels||''))}
industry_kpis: ${br((industry.kpis||''))}` : '';
  return `scenario_id: ${s.scenario_id}
name: ${br(s.name)}
agent_name: ${br(s.agent_name || 'Agent')}
best_reply_shapes: ${brList(s.best_reply_shapes)}
triggers: >${br('\\n  ' + (s.triggers || ''))}
how_it_works: >${br('\\n  ' + (s.how_it_works || ''))}
tool_stack_dev: >${br('\\n  ' + (s.tool_stack_dev || ''))}
risk_notes: >${br('\\n  ' + (s.risk_notes || ''))}
roi_hypothesis: >${br('\\n  ' + (s.roi_hypothesis || ''))}
tags: [${listify(s.tags).join(', ')}]${ind}`;
}

/* ===== UI wiring ===== */
function populateUI(list) {
  scenarioSel.innerHTML = '';
  list.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.scenario_id;
    opt.textContent = s.scenario_id;
    opt.title = s.name || s.scenario_id;
    scenarioSel.appendChild(opt);
  });
  countsEl.textContent = `Loaded ${ALL.length} scenarios • ${INDUSTRIES.length} industries`;
  if (list.length) applyScenario(list[0].scenario_id);
}

function applyScenario(id) {
  const s = MAP[id] || ALL.find(x => x.scenario_id === id);
  if (!s) return;
  const industry = matchIndustryForScenario(s);
  scenarioSel.value = s.scenario_id;
  channelSel.value = recommendedChannel(s);
  bpTA.value = previewYaml(s, industry);
}

/* ===== Suggestions (no datalist) ===== */
function renderSuggestions(q=''){
  if (!Array.isArray(ALL) || !ALL.length) { suggestWrap.innerHTML=''; return; }
  const needle = q.trim().toLowerCase();
  let matches = ALL;
  if (needle) {
    matches = ALL.filter(s =>
      s.scenario_id.toLowerCase().includes(needle) ||
      (s.name||'').toLowerCase().includes(needle)
    );
  }
  matches = matches.slice(0, 50);
  if (!matches.length){ suggestWrap.innerHTML=''; return; }
  const box = document.createElement('div');
  box.className = 'suggest-box';
  box.innerHTML = matches.map(m => `
    <div class="suggest-item" data-id="${m.scenario_id}">
      <span class="suggest-id">${m.scenario_id}</span>
      <span class="suggest-name">${(m.name||'').replace(/</g,'&lt;')}</span>
    </div>`).join('');
  box.addEventListener('click', (e)=>{
    const el = e.target.closest('.suggest-item');
    if (!el) return;
    const id = el.getAttribute('data-id');
    if (MAP[id]) {
      $('search').value = id;
      applyScenario(id);
      suggestWrap.innerHTML='';
    }
  });
  suggestWrap.innerHTML = '';
  suggestWrap.appendChild(box);
}
$('search').addEventListener('focus', e => renderSuggestions(e.target.value));
$('search').addEventListener('input', e => renderSuggestions(e.target.value));
$('search').addEventListener('blur', () => setTimeout(()=> suggestWrap.innerHTML='', 150));
$('search').addEventListener('keydown', (e)=>{
  if (e.key === 'Enter'){
    const v = e.target.value.trim();
    if (MAP[v]) { applyScenario(v); suggestWrap.innerHTML=''; return; }
    const first = ALL.find(s =>
      s.scenario_id.toLowerCase().includes(v.toLowerCase()) ||
      (s.name||'').toLowerCase().includes(v.toLowerCase())
    );
    if (first){ e.target.value = first.scenario_id; applyScenario(first.scenario_id); suggestWrap.innerHTML=''; }
  }
});

/* ===== Derive modules (short) ===== */
function deriveModulesFromNarrative(s, industry){
  const txt = [s.how_it_works,s.roi_hypothesis,s.name,(s.tags||[]).join(' '), industry?.painpoints, industry?.kpis, industry?.channels].map(x=>x||'').join(' ').toLowerCase();
  const mods = new Set();
  if (/\b(schedule|appointment|no-?show|calendar)\b/.test(txt)) mods.add('ReminderFlow');
  if (/\b(waitlist|backfill|cancell)/.test(txt)) mods.add('Waitlist');
  if (/\b(gcal|google calendar|dentrix|opendental|eaglesoft)\b/.test(txt)) mods.add('CalendarSync');
  if (/\b(invoice|payment|overdue|billing|collection)\b/.test(txt)) mods.add('BillingChase');
  if (/\b(lead|qualification|prospect|inbound)\b/.test(txt)) mods.add('LeadScoring');
  if (!mods.size) mods.add('ReminderFlow');
  return [...mods];
}

/* ===== LLM prompt (short) ===== */
function buildLLMPrompt(s, industry, modules){
  const role = (s.agent_name || 'Agent').trim();
  const sector = industry?.industry_id || (s.name || 'industry');
  return `You are a ${role} for ${sector}. Modules: ${modules.join(', ')}. Keep replies concise and action-oriented. Respect consent/opt-out.`;
}

/* ===== Workflow generator (scheduling demo, safe) ===== */
function buildWorkflowJSON(s, channel) {
  const industry = matchIndustryForScenario(s);
  const modules = deriveModulesFromNarrative(s, industry);

  const wf = { name: `${s.scenario_id} – ${s.agent_name || 'Agent'} (Demo)`, nodes: [], connections:{}, active:false, settings:{}, staticData:null, pinData:{} };
  const add = (name,type,x,y,parameters={},extra={}) => wf.nodes.push({ name, type, typeVersion:(type==="n8n-nodes-base.manualTrigger"||type==="n8n-nodes-base.wait")?1:2, position:[x,y], parameters, ...extra });
  const connect = (a,b) => { wf.connections[a] ||= { main:[[]] }; wf.connections[a].main[0].push({ node:b, type:"main", index:0 }); };

  add("Manual Trigger","n8n-nodes-base.manualTrigger",-1400,-20);
  add("Design / Reasoning","n8n-nodes-base.function",-1260,-160,{ functionCode:`return [{ json: { scenario_id:"${s.scenario_id}", name:"${(s.name||'').replace(/"/g,'\\"')}", modules:${JSON.stringify(modules)} } }];`});
  add("Set Config","n8n-nodes-base.function",-1180,-20,{ functionCode:`return [{ json: { demoMode:true, channel:"${channel||'email'}", allowedRecipients:["kevanm.spain@gmail.com"], allowedPhones:["+"], twilioFromSms:"+13412184164", twilioFromWhatsApp:"whatsapp:+14155238886", twilioFromVoice:"+13412184164" } }];`});
  connect("Manual Trigger","Design / Reasoning"); connect("Design / Reasoning","Set Config");

  add("Load Data","n8n-nodes-base.function",-940,-20,{ functionCode:`return [{ json: { appointments:[{ first:"Sara", email:"sara@example.com", phone:"+15551234567", doctor:"Dr. Lee", time:"2025-10-02T10:00"}] } }];`});
  connect("Set Config","Load Data");

  add("Compose Message","n8n-nodes-base.function",-720,-20,{ functionCode:`const a=items[0].json.appointments[0]; const d=new Date(a.time); const ds=d.toLocaleDateString(); const ts=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); return [{ json:{ to:"kevanm.spain@gmail.com", toPhone:"+34XXXXXXXXX", subject:"Reminder – "+a.doctor, text:\`Hi \${a.first}, appt on \${ds} at \${ts}. Reply 1 confirm, 2 reschedule, 3 cancel.\`, tts:"Appointment reminder." } }];`});
  connect("Load Data","Compose Message");

  // Simple email path only (safe). You can re-enable Twilio once credentials are set.
  add("Email Send","n8n-nodes-base.emailSend",-480,-20,{ fromEmail:"", toEmail:"={{$json['to']}}", subject:"={{$json['subject']}}", text:"={{$json['text']}}" },{ notes:"Select SMTP in n8n if demoMode=false" });
  connect("Compose Message","Email Send");

  add("Wait for Reply","n8n-nodes-base.wait",-200,-20,{});
  connect("Email Send","Wait for Reply");

  add("Parse Intent","n8n-nodes-base.function",20,-20,{ functionCode:`const t="1"; let intent='CONFIRM'; if(t==="2")intent='RESCHEDULE'; if(t==="3")intent='CANCEL'; return [{ json:{ intent } }];`});
  connect("Wait for Reply","Parse Intent");

  add("Update System (Mock)","n8n-nodes-base.function",260,-20,{ functionCode:`console.log("Intent:", $json.intent); return items;`});
  connect("Parse Intent","Update System (Mock)");

  // LLM prompt node (disabled OpenAI for safety)
  const prompt = buildLLMPrompt(s, industry, modules).replace(/`/g,'\\`');
  add("LLM Prompt","n8n-nodes-base.function",-720,-200,{ functionCode:`return [{ json: { prompt:\`${prompt}\` } }];`});
  add("OpenAI Chat (disabled)","n8n-nodes-base.openAi",-480,-200,{ operation:"chat", model:"gpt-4o-mini", additionalFields:{ systemMessage:"={{$json.prompt}}" } },{ disabled:true, credentials:{ openAiApi:{ name:"openai-default" } }});
  connect("LLM Prompt","OpenAI Chat (disabled)");

  return wf;
}

/* ===== Download ===== */
function downloadJSON(obj, filename) {
  const txt = JSON.stringify(obj, null, 2);
  const blob = new Blob([txt], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}

/* ===== Bootstrap ===== */
async function bootstrap(){
  // show runtime JS errors on screen
  window.addEventListener('error', (e)=>{
    setStatus('Client error', e.message, false, true);
    debugOut.textContent += `\n[client-error] ${e.message}\n${(e.error && e.error.stack) || ''}`;
  });

  try {
    const [sc, ind] = await Promise.all([getJSON('/api/scenarios'), getJSON('/api/industries')]);
    debugOut.textContent = `GET /api/scenarios → ${sc.status}\n${sc.raw.slice(0,500)}\n\nGET /api/industries → ${ind.status}\n${ind.raw.slice(0,500)}\n`;

    if (!sc.ok || !sc.json?.ok) throw new Error(`/api/scenarios failed (${sc.status}) ${sc.json?.error || ''}`);
    if (!ind.ok || !ind.json?.ok) throw new Error(`/api/industries failed (${ind.status}) ${ind.json?.error || ''}`);

    ALL = (sc.json.items || []).map(x => ({ ...x, best_reply_shapes: listify(x.best_reply_shapes), tags: listify(x.tags) }));
    MAP = Object.fromEntries(ALL.map(x => [x.scenario_id, x]));
    INDUSTRIES = (ind.json.items || []);
    IND_MAP = Object.fromEntries(INDUSTRIES.map(it => [norm(it.industry_id || ''), it]));

    if (!ALL.length){
      // hard fallback demo if sheet is empty
      ALL = [{ scenario_id:'tier1_dso_SCHEDULING_NO_SHOWS', name:'dental', agent_name:'Scheduling Agent', best_reply_shapes:['sms','email'] }];
      MAP = { [ALL[0].scenario_id]: ALL[0] };
      setStatus('No scenarios found — using demo fallback', '', false, true);
    } else {
      setStatus('Loaded', `${ALL.length} scenarios • ${INDUSTRIES.length} industries`, true, false);
    }

    populateUI(ALL);
  } catch (e) {
    // full fallback
    setStatus('Data load failed — using demo fallback', e.message || '', false, true);
    debugOut.textContent += `\n[bootstrap-error] ${e.message || e}`;
    const fallbackS = { scenario_id:'tier1_dso_SCHEDULING_NO_SHOWS', name:'dental', agent_name:'Scheduling Agent', best_reply_shapes:['sms','email'] };
    const fallbackI = { industry_id:'dental', painpoints:'no-shows; front-desk overload', kpis:'no-show rate; utilization' };
    ALL = [fallbackS]; MAP = { [fallbackS.scenario_id]: fallbackS };
    INDUSTRIES = [fallbackI]; IND_MAP = { [norm(fallbackI.industry_id)]: fallbackI };
    populateUI(ALL);
  }
}

/* ===== Buttons ===== */
$('build').addEventListener('click', () => {
  const sid = (scenarioSel.value || '').trim();
  const s = MAP[sid];
  if (!s) { setStatus('✗ No scenario selected', '', false, true); return; }
  const wf = buildWorkflowJSON(s, channelSel.value);
  downloadJSON(wf, `${sid}-workflow.json`);
  setStatus('✓ Downloaded workflow', `${sid}-workflow.json`, true, false);
});

$('pingScenarios').addEventListener('click', async ()=>{
  const r = await getJSON('/api/scenarios'); debugOut.textContent += `\n\n[ping scenarios] ${r.status}\n${r.raw.slice(0,800)}\n`;
});
$('pingIndustries').addEventListener('click', async ()=>{
  const r = await getJSON('/api/industries'); debugOut.textContent += `\n\n[ping industries] ${r.status}\n${r.raw.slice(0,800)}\n`;
});

scenarioSel.addEventListener('change', () => applyScenario(scenarioSel.value));
searchEl.addEventListener('focus', e => renderSuggestions(e.target.value));
searchEl.addEventListener('input', e => renderSuggestions(e.target.value));
searchEl.addEventListener('blur', () => setTimeout(()=> suggestWrap.innerHTML='', 150));
searchEl.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter'){
    const v = e.target.value.trim();
    if (MAP[v]) { applyScenario(v); suggestWrap.innerHTML=''; return; }
    const first = ALL.find(s =>
      s.scenario_id.toLowerCase().includes(v.toLowerCase()) ||
      (s.name||'').toLowerCase().includes(v.toLowerCase())
    );
    if (first){ e.target.value = first.scenario_id; applyScenario(first.scenario_id); suggestWrap.innerHTML=''; }
  }
});

/* go */
bootstrap();
</script>
</body>
</html>
