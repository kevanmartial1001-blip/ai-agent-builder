<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Agent Builder</title>
<style>
  :root{--bg:#0b0c10;--card:#141824;--ink:#e9edf1;--muted:#9aa6b2;--accent:#5eead4;--line:#232735}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:32px auto;padding:0 20px}
  h1{margin:0 0 16px;font-size:26px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin:12px 0 6px}
  select,textarea,input,button{width:100%;background:#0f1218;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  textarea{min-height:160px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px}
  button{cursor:pointer} .primary{background:var(--accent);color:#0b0c10;border:none;font-weight:700}
  .hint{color:var(--muted);font-size:13px}
  #suggestions{position:relative}
  .suggest-box{position:absolute;left:0;right:0;background:#0f1218;border:1px solid var(--line);border-radius:10px;margin-top:6px;max-height:260px;overflow:auto;z-index:10}
  .suggest-item{padding:8px 10px;cursor:pointer;display:flex;gap:8px;align-items:baseline}
  .suggest-item:hover{background:#121826}
  .suggest-id{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
  .suggest-name{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dbg{font:12px/1.4 ui-monospace,Consolas,monospace;color:#aaa;margin-top:8px;word-break:break-word}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Agent Builder <small id="counts" class="hint"></small></h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="scenario">Scenario (<code>scenario_id</code>)</label>
        <select id="scenario"><option value="">Loading…</option></select>
      </div>
      <div>
        <label for="channel">Channel (auto)</label>
        <select id="channel">
          <option value="email">Email</option>
          <option value="sms">SMS (Twilio)</option>
          <option value="whatsapp">WhatsApp (Twilio)</option>
          <option value="call">Voice Call (Twilio)</option>
        </select>
      </div>
    </div>

    <label for="search">Search the full catalog (8k+)</label>
    <input id="search" placeholder="Type scenario_id or name…  e.g. tier1_dso_SCHEDULING_NO_SHOWS" autocomplete="off" />
    <div id="suggestions"></div>

    <label for="bp">Preview</label>
    <textarea id="bp" readonly></textarea>

    <div class="row" style="margin-top:10px">
      <button id="build" class="primary">Download n8n JSON</button>
      <div class="hint">Imports directly in n8n</div>
    </div>
    <div id="dbg" class="dbg"></div>
  </div>
</div>

<script>
/* ---------- small utils ---------- */
const $ = id => document.getElementById(id);
const countsEl = $('counts'), scenarioSel = $('scenario'), channelSel = $('channel'),
      searchEl = $('search'), suggestWrap = $('suggestions'), bpTA = $('bp'), dbg = $('dbg');

let ALL = [], MAP = {};
let INDUSTRIES = [], IND_MAP = {};

const listify = v => Array.isArray(v) ? v : String(v ?? '')
  .replace(/^\[|\]$/g,'')
  .split(/[;,|\n|\|,]+/)
  .map(x=>x.replace(/^['"]|['"]$/g,'').trim())
  .filter(Boolean);

const norm = t => (t||'').toLowerCase();

/* ---------- fetch helpers ---------- */
async function getJSON(url){
  const r = await fetch(url, { cache: 'no-store' });
  const raw = await r.text();
  try { return { ok:r.ok, status:r.status, json: JSON.parse(raw), raw }; }
  catch { return { ok:r.ok, status:r.status, json:null, raw }; }
}

/* ---------- channel recommendation ---------- */
function recommendedChannel(row) {
  const shapes = listify(row.best_reply_shapes).map(x=>x.toLowerCase());
  const set = new Set(shapes.map(s =>
    s.includes('whatsapp')?'whatsapp':
    (s.includes('sms')||s.includes('text'))?'sms':
    (s.includes('voice')||s.includes('call'))?'call':
    s.includes('email')?'email':s));
  if (set.has('sms')) return 'sms';
  if (set.has('whatsapp')) return 'whatsapp';
  if (set.has('email')) return 'email';
  if (set.has('call')) return 'call';
  return 'email';
}

/* ---------- industry matching & preview ---------- */
function matchIndustryForScenario(s) {
  const key = norm(s.name || '');
  return IND_MAP[key] || null;
}
function previewYaml(s, industry) {
  const br = v => (v==null || String(v).trim()==='' ? '' : String(v));
  const brList = arr => `[${listify(arr).join(', ')}]`;
  const ind = industry ? `
industry_id: ${industry.industry_id}
industry_painpoints: ${(industry.painpoints||'').toString().slice(0,220)}...` : '';
  return `scenario_id: ${s.scenario_id}
name: ${br(s.name)}
agent_name: ${br(s.agent_name || 'Agent')}
best_reply_shapes: ${brList(s.best_reply_shapes)}
triggers: >
  ${br(s.triggers || '')}
how_it_works: >
  ${br(s.how_it_works || '')}
roi_hypothesis: >
  ${br(s.roi_hypothesis || '')}
tags: [${listify(s.tags).join(', ')}]${ind}`;
}

/* ---------- UI ---------- */
function populateUI(list) {
  scenarioSel.innerHTML = '';
  const frag = document.createDocumentFragment();
  list.forEach(s => {
    const opt=document.createElement('option');
    opt.value=s.scenario_id;
    opt.textContent=s.scenario_id;
    opt.title=s.name||s.scenario_id;
    frag.appendChild(opt);
  });
  scenarioSel.appendChild(frag);
  countsEl.textContent = `Loaded ${ALL.length} scenarios • ${INDUSTRIES.length} industries`;
  if (list.length) applyScenario(list[0].scenario_id);
}
function applyScenario(id) {
  const s = MAP[id] || ALL.find(x => x.scenario_id === id);
  if (!s) return;
  const industry = matchIndustryForScenario(s);
  scenarioSel.value = s.scenario_id;
  channelSel.value = recommendedChannel(s);
  bpTA.value = previewYaml(s, industry);
}

/* ---------- remote search (full 8k) ---------- */
let searchTimer = null;
async function remoteSearch(q) {
  if (!q || q.trim().length < 2) { suggestWrap.innerHTML = ''; return; }
  const url = `/api/scenarios?q=${encodeURIComponent(q)}&limit=50`;
  const res = await getJSON(url);
  const items = (res.ok && res.json && Array.isArray(res.json.items)) ? res.json.items : [];
  renderSuggestions(items);
}
function renderSuggestions(matches){
  if (!matches || !matches.length) { suggestWrap.innerHTML=''; return; }
  const box = document.createElement('div'); box.className = 'suggest-box';
  box.innerHTML = matches.map(m => {
    const id = (m.scenario_id||'').replace(/</g,'&lt;');
    const nm = (m.name||'').replace(/</g,'&lt;');
    return `<div class="suggest-item" data-id="${id}">
      <span class="suggest-id">${id}</span>
      <span class="suggest-name">${nm}</span>
    </div>`;
  }).join('');
  box.addEventListener('click', (e)=>{
    const el=e.target.closest('.suggest-item'); if(!el)return;
    const id=el.getAttribute('data-id');
    // if unknown, stash minimal object so applyScenario can show preview
    if (!MAP[id]) {
      const m = matches.find(x=>x.scenario_id===id);
      if (m) { MAP[id] = {
        scenario_id: m.scenario_id||'',
        name: m.name||'',
        triggers: m.triggers||'',
        best_reply_shapes: listify(m.best_reply_shapes),
        risk_notes: m.risk_notes||'',
        agent_name: m.agent_name||'',
        how_it_works: m.how_it_works||'',
        tool_stack_dev: m.tool_stack_dev||'',
        tool_stack_autonomous: m.tool_stack_autonomous||'',
        tags: listify(m.tags||m['tags (;)']||'')
      }; }
    }
    $('search').value = id;
    applyScenario(id);
    suggestWrap.innerHTML='';
  });
  suggestWrap.innerHTML=''; suggestWrap.appendChild(box);
}

$('search').addEventListener('input', (e)=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=> remoteSearch(e.target.value), 180);
});
$('search').addEventListener('focus', ()=> {
  if (ALL.length) renderSuggestions(ALL.slice(0,20)); // light suggestion on focus
});
$('search').addEventListener('blur', ()=> setTimeout(()=> suggestWrap.innerHTML='', 150));
$('search').addEventListener('keydown', (e)=>{
  if (e.key === 'Enter'){
    const v = e.target.value.trim();
    if (MAP[v]) { applyScenario(v); suggestWrap.innerHTML=''; return; }
    // try a remote search once
    remoteSearch(v);
  }
});
scenarioSel.addEventListener('change', () => applyScenario(scenarioSel.value));

/* ---------- bootstrap (load only 50) ---------- */

async function getJSON(url){
  const r = await fetch(url, { cache: 'no-store' });
  const raw = await r.text();
  try { return { ok:r.ok, status:r.status, json: JSON.parse(raw), raw }; }
  catch { return { ok:r.ok, status:r.status, json:null, raw }; }
}

function listify(v){ return Array.isArray(v) ? v : String(v ?? '')
  .replace(/^\[|\]$/g,'')
  .split(/[;,|\n|\|,]+/)
  .map(x=>x.replace(/^['"]|['"]$/g,'').trim())
  .filter(Boolean); }

function populateUI(list){
  const sel = document.getElementById('scenario');
  sel.innerHTML = '';
  const frag = document.createDocumentFragment();
  list.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.scenario_id; o.textContent=s.scenario_id; o.title=s.name||s.scenario_id;
    frag.appendChild(o);
  });
  sel.appendChild(frag);
  document.getElementById('counts')?.remove(); // optional if you had a counter
  if (list.length) applyScenario(list[0].scenario_id);
}

// ↓↓↓ REPLACE YOUR OLD bootstrap() WITH THIS ↓↓↓
async function bootstrap(){
  try{
    // Hard limit 50 for fast render
    const [sc, ind] = await Promise.all([
      getJSON('/api/scenarios?cursor=0&limit=50'),
      getJSON('/api/industries'),
    ]);

    const sitems = (sc.ok && sc.json && Array.isArray(sc.json.items)) ? sc.json.items : [];
    const iitems = (ind.ok && ind.json && Array.isArray(ind.json.items)) ? ind.json.items : [];

    // Build globals expected by the rest of the page
    window.ALL = sitems.map(x => ({
      scenario_id: x.scenario_id || '',
      name: x.name || '',
      triggers: x.triggers || '',
      best_reply_shapes: listify(x.best_reply_shapes),
      risk_notes: x.risk_notes || '',
      agent_name: x.agent_name || '',
      how_it_works: x.how_it_works || '',
      tool_stack_dev: x.tool_stack_dev || '',
      tool_stack_autonomous: x.tool_stack_autonomous || '',
      tags: listify(x.tags || x['tags (;)'] || '')
    })).filter(s => s.scenario_id);

    window.MAP = Object.fromEntries(window.ALL.map(x => [x.scenario_id, x]));

    window.INDUSTRIES = iitems.map(it => ({
      industry_id: it.industry_id || it.name || '',
      painpoints: it.core_pains || it.painpoints || '',
      kpis: it.success_metrics || it.kpi_examples || '',
      channels: it.channels || it.core_channels || '',
      vocabulary: it.agent_language_prompt || ''
    })).filter(i => i.industry_id);

    window.IND_MAP = Object.fromEntries(window.INDUSTRIES.map(it => [ (it.industry_id||'').toLowerCase(), it ]));

    // If nothing came back, show a tiny fallback so the page stays usable
    if (!window.ALL.length) {
      const fallbackS = {
        scenario_id:'tier1_dso_SCHEDULING_NO_SHOWS',
        name:'tier1_dso',
        agent_name:'Scheduling Agent',
        best_reply_shapes:['sms','email'],
        how_it_works:'Remind, confirm, backfill.',
        roi_hypothesis:'Reduce no-shows 30%+'
      };
      const fallbackI = { industry_id:'tier1_dso', painpoints:'no-shows; front-desk overload', kpis:'no-show rate; utilization' };
      window.ALL=[fallbackS]; window.MAP={ [fallbackS.scenario_id]: fallbackS };
      window.INDUSTRIES=[fallbackI]; window.IND_MAP={ [fallbackI.industry_id]: fallbackI };
    }

    populateUI(window.ALL);
  } catch (e){
    // Last-resort fallback
    const fallbackS = {
      scenario_id:'tier1_dso_SCHEDULING_NO_SHOWS',
      name:'tier1_dso',
      agent_name:'Scheduling Agent',
      best_reply_shapes:['sms','email'],
      how_it_works:'Remind, confirm, backfill.',
      roi_hypothesis:'Reduce no-shows 30%+'
    };
    const fallbackI = { industry_id:'tier1_dso', painpoints:'no-shows; front-desk overload', kpis:'no-show rate; utilization' };
    window.ALL=[fallbackS]; window.MAP={ [fallbackS.scenario_id]: fallbackS };
    window.INDUSTRIES=[fallbackI]; window.IND_MAP={ [fallbackI.industry_id]: fallbackI };
    populateUI(window.ALL);
  }
}
bootstrap();

/* ---------- template selection + builder (same as before) ---------- */
function pickTemplate(s, industry){
  const text = [s.scenario_id,s.name,s.triggers,s.how_it_works,s.roi_hypothesis,(s.tags||[]).join(' '),industry?.painpoints,industry?.kpis]
    .filter(Boolean).join(' ').toLowerCase();
  if (/(bill|invoice|payment|overdue|collection|ar)/.test(text)) return 'billing';
  if (/(lead|qualification|prospect|inbound|demo|trial|signup)/.test(text)) return 'lead';
  return 'scheduling';
}
function deriveModulesFromNarrative(s, industry){
  const txt = [s.how_it_works,s.roi_hypothesis,s.triggers,(s.tags||[]).join(' '),industry?.painpoints,industry?.kpis,industry?.channels].map(x=>x||'').join(' ').toLowerCase();
  const mods = new Set();
  if (/\b(schedule|appointment|no-?show|calendar)\b/.test(txt)) mods.add('ReminderFlow');
  if (/\b(waitlist|backfill|cancell)\b/.test(txt)) mods.add('Waitlist');
  if (/\b(gcal|google calendar|dentrix|opendental|eaglesoft)\b/.test(txt)) mods.add('CalendarSync');
  if (/\b(invoice|payment|overdue|billing|collection)\b/.test(txt)) mods.add('BillingChase');
  if (/\b(lead|qualification|prospect|inbound)\b/.test(txt)) mods.add('LeadScoring');
  if (/\b(slack|daily summary|handoff|alert)\b/.test(txt)) mods.add('SlackSummary');
  if (!mods.size) mods.add('ReminderFlow');
  return [...mods];
}
function buildLLMPrompt(s, industry, modules, key){
  const role = (s.agent_name || 'Agent').trim();
  const sector = industry?.industry_id || (s.name || 'industry');
  const how = (s.how_it_works || '').trim();
  const roi = (s.roi_hypothesis || '').trim();
  const pains = industry?.painpoints || '';
  const kpis = industry?.kpis || '';
  const goals = { scheduling:['reduce no-shows','maximize utilization'], billing:['collect payment faster','reduce DSO'], lead:['qualify fast','book a call'] }[key] || [];
  return [
`You are a ${role} for the ${sector} sector.`,
`How it works: ${how || 'N/A'}`,
`ROI hypothesis: ${roi || 'N/A'}`,
industry ? `Industry painpoints: ${pains || 'N/A'}` : null,
industry ? `Industry KPIs: ${kpis || 'N/A'}` : null,
`Enabled modules: ${modules.join(', ')}`,
`Objectives: ${goals.join('; ')}`,
`Rules: concise, warm; honor consent/opt-out; SMS/WA ≤320 chars; voice short TTS.`,
`Output one message string for the selected channel.`
  ].filter(Boolean).join('\n');
}
function wfSkeleton(name){ return { name, nodes:[], connections:{}, active:false, settings:{}, staticData:null, pinData:{} }; }
function node(nodes, name, type, pos, params={}, extra={}){ nodes.push({ name, type, typeVersion:(/manualTrigger|wait$/.test(type)?1:2), position:pos, parameters:params, ...extra }); }
function link(conns, a,b){ conns[a] ||= { main:[[]] }; conns[a].main[0].push({ node:b, type:"main", index:0 }); }
function cfgNode(channel){
  return { name:"Set Config", type:"n8n-nodes-base.function", typeVersion:2, position:[-1180,-20], parameters:{ functionCode:
`return [{ json: {
  demoMode: true,
  channel: "${channel}",
  allowedRecipients: ["kevanm.spain@gmail.com"],
  allowedPhones: ["+34XXXXXXXXX"],
  overrideTo: "kevanm.spain@gmail.com",
  overrideToPhone: "+34XXXXXXXXX",
  twilioFromSms: "+13412184164",
  twilioFromWhatsApp: "whatsapp:+14155238886",
  twilioFromVoice: "+13412184164"
}}];` } };
}
function branchChannels(wf, s){
  node(wf.nodes,"Channel = Email?","n8n-nodes-base.if",[-520,-160],{conditions:{string:[{value1:"={{$items('Set Config',0,0).json.channel}}",operation:"equal",value2:"email"}]} );
  node(wf.nodes,"Channel = SMS?","n8n-nodes-base.if",[-520,-40], {conditions:{string:[{value1:"={{$items('Set Config',0,0).json.channel}}",operation:"equal",value2:"sms"}]} );
  node(wf.nodes,"Channel = WhatsApp?","n8n-nodes-base.if",[-520,80], {conditions:{string:[{value1:"={{$items('Set Config',0,0).json.channel}}",operation:"equal",value2:"whatsapp"}]} );
  node(wf.nodes,"Channel = Call?","n8n-nodes-base.if",[-520,200], {conditions:{string:[{value1:"={{$items('Set Config',0,0).json.channel}}",operation:"equal",value2:"call"}]} );
  link(wf.connections,"Compose Message","Channel = Email?");
  link(wf.connections,"Compose Message","Channel = SMS?");
  link(wf.connections,"Compose Message","Channel = WhatsApp?");
  link(wf.connections,"Compose Message","Channel = Call?");
  // Email
  node(wf.nodes,"Email Allowlist","n8n-nodes-base.function",[-340,-240],{functionCode:"const cfg=$items('Set Config',0,0).json;const to=$json.to||'';const ok=(cfg.allowedRecipients||[]).includes(to);return [{json:{ok}}];"});
  node(wf.nodes,"Email Allowed?","n8n-nodes-base.if",[-180,-240],{conditions:{boolean:[{value1:"={{$item(0).$node['Email Allowlist'].json.ok}}"}]} );
  node(wf.nodes,"Email Send","n8n-nodes-base.emailSend",[0,-240],{fromEmail:"",toEmail:"={{$json['to']}}",subject:"={{$json['subject']}}",text:"={{$json['text']}}",options:{ senderName:"Agent" }},{notes:"Pick SMTP credentials when demoMode=false"});
  link(wf.connections,"Channel = Email?","Email Allowlist"); wf.connections["Channel = Email?"].main[1]=[];
  link(wf.connections,"Email Allowlist","Email Allowed?"); link(wf.connections,"Email Allowed?","Email Send"); wf.connections["Email Allowed?"].main[1]=[{node:"Wait for Reply",type:"main",index:0}];
  // SMS
  node(wf.nodes,"Phone Allowlist","n8n-nodes-base.function",[-340,-40],{functionCode:"const cfg=$items('Set Config',0,0).json;const p=$json.toPhone||'';const ok=(cfg.allowedPhones||[]).includes(p);return [{json:{ok}}];"});
  node(wf.nodes,"Phone Allowed?","n8n-nodes-base.if",[-180,-40],{conditions:{boolean:[{value1:"={{$item(0).$node['Phone Allowlist'].json.ok}}"}]} );
  node(wf.nodes,"Twilio SMS","n8n-nodes-base.twilio",[0,-40],{resource:"message",operation:"send",from:"={{$items('Set Config',0,0).json.twilioFromSms}}",to:"={{$json['toPhone']}}",message:"={{$json['text']}}"}, {disabled:true,credentials:{ twilioApi:{ name:"twilio-default" } }});
  link(wf.connections,"Channel = SMS?","Phone Allowlist"); wf.connections["Channel = SMS?"].main[1]=[];
  link(wf.connections,"Phone Allowlist","Phone Allowed?"); link(wf.connections,"Phone Allowed?","Twilio SMS"); wf.connections["Phone Allowed?"].main[1]=[{node:"Wait for Reply",type:"main",index:0}];
  // WA
  node(wf.nodes,"WA Allowlist","n8n-nodes-base.function",[-340,80],{functionCode:"const cfg=$items('Set Config',0,0).json;const p=$json.toPhone||'';const ok=(cfg.allowedPhones||[]).includes(p);return [{json:{ok}}];"});
  node(wf.nodes,"WA Allowed?","n8n-nodes-base.if",[-180,80],{conditions:{boolean:[{value1:"={{$item(0).$node['WA Allowlist'].json.ok}}"}]} );
  node(wf.nodes,"Twilio WhatsApp","n8n-nodes-base.twilio",[0,80],{resource:"message",operation:"send",from:"={{$items('Set Config',0,0).json.twilioFromWhatsApp}}",to:"={{'whatsapp:' + $json['toPhone']}}",message:"={{$json['text']}}"}, {disabled:true,credentials:{ twilioApi:{ name:"twilio-default" } }});
  link(wf.connections,"Channel = WhatsApp?","WA Allowlist"); wf.connections["Channel = WhatsApp?"].main[1]=[];
  link(wf.connections,"WA Allowlist","WA Allowed?"); link(wf.connections,"WA Allowed?","Twilio WhatsApp"); wf.connections["WA Allowed?"].main[1]=[{node:"Wait for Reply",type:"main",index:0}];
  // Call
  node(wf.nodes,"Call Allowlist","n8n-nodes-base.function",[-340,200],{functionCode:"const cfg=$items('Set Config',0,0).json;const p=$json.toPhone||'';const ok=(cfg.allowedPhones||[]).includes(p);return [{json:{ok}}];"});
  node(wf.nodes,"Call Allowed?","n8n-nodes-base.if",[-180,200],{conditions:{boolean:[{value1:"={{$item(0).$node['Call Allowlist'].json.ok}}"}]} );
  node(wf.nodes,"Twilio Call (TTS)","n8n-nodes-base.twilio",[0,200],{resource:"call",operation:"create",from:"={{$items('Set Config',0,0).json.twilioFromVoice}}",to:"={{$json['toPhone']}}",text:"={{$json['tts']}}",sayOrPlay:"say"}, {disabled:true,credentials:{ twilioApi:{ name:"twilio-default" } }});
  link(wf.connections,"Channel = Call?","Call Allowlist"); wf.connections["Channel = Call?"].main[1]=[];
  link(wf.connections,"Call Allowlist","Call Allowed?"); link(wf.connections,"Call Allowed?","Twilio Call (TTS)"); wf.connections["Call Allowed?"].main[1]=[{node:"Wait for Reply",type:"main",index:0}];
}
function llmNodes(wf, prompt){
  node(wf.nodes,"LLM Prompt","n8n-nodes-base.function",[-720,-200],{functionCode:`return [{ json: { prompt:\`${prompt.replace(/`/g,'\\`')}\` } }];`});
  node(wf.nodes,"OpenAI Chat (disabled)","n8n-nodes-base.openAi",[-480,-200],{operation:"chat",model:"gpt-4o-mini",additionalFields:{systemMessage:"={{$json.prompt}}"}},{disabled:true,credentials:{openAiApi:{name:"openai-default"}}});
  link(wf.connections,"LLM Prompt","OpenAI Chat (disabled)");
}
function wfScheduling(s, industry){
  const modules = deriveModulesFromNarrative(s, industry);
  const wf = wfSkeleton(`${s.scenario_id} – ${s.agent_name || 'Scheduling Agent'} (Demo)`);
  node(wf.nodes,"Manual Trigger","n8n-nodes-base.manualTrigger",[-1460,-20],{});
  node(wf.nodes,"Design / Reasoning","n8n-nodes-base.function",[-1320,-160],{functionCode:`return [{ json:{ scenario_id:"${s.scenario_id}", modules:${JSON.stringify(modules)}, industry:${JSON.stringify(industry||null)} } }];`});
  wf.nodes.push(cfgNode(recommendedChannel(s)));
  link(wf.connections,"Manual Trigger","Design / Reasoning"); link(wf.connections,"Design / Reasoning","Set Config");
  node(wf.nodes,"Load Data","n8n-nodes-base.function",[-940,-20],{functionCode:`return [{ json:{ appointments:[{ first:"Sara", email:"sara@example.com", phone:"+15551234567", doctor:"Dr. Lee", time:"2025-10-02T10:00"}] } }];`});
  link(wf.connections,"Set Config","Load Data");
  const HOW=(s.how_it_works||'').replace(/`/g,'\\`'), ROI=(s.roi_hypothesis||'').replace(/`/g,'\\`'), PAI=(industry?.painpoints||'').replace(/`/g,'\\`');
  node(wf.nodes,"Compose Message","n8n-nodes-base.function",[-720,-20],{functionCode:
`const a=items[0].json.appointments[0];
const d=new Date(a.time), ds=d.toLocaleDateString(), ts=d.toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'});
const ctx=[\`${HOW}\`,\`${ROI}\`,\`${PAI}\`].filter(Boolean).join(' ');
return [{ json:{
  to:"kevanm.spain@gmail.com", toPhone:"+34XXXXXXXXX",
  subject:"Appointment reminder – "+a.doctor,
  text:\`Hi \${a.first}, your appointment is on \${ds} at \${ts}.\${ctx?' '+ctx:''} Reply 1 CONFIRM, 2 RESCHEDULE, 3 CANCEL.\`,
  tts:"Appointment reminder."
}}];`});
  link(wf.connections,"Load Data","Compose Message");
  llmNodes(wf, buildLLMPrompt(s, industry, modules, 'scheduling'));
  branchChannels(wf, s);
  node(wf.nodes,"Wait for Reply","n8n-nodes-base.wait",[260,-20],{}); ["Email Send","Twilio SMS","Twilio WhatsApp","Twilio Call (TTS)"].forEach(n=>link(wf.connections,n,"Wait for Reply"));
  node(wf.nodes,"Parse Intent","n8n-nodes-base.function",[520,-20],{functionCode:
`const t=($json.Body||$json.text||"1").toLowerCase(); let intent='HUMAN';
if (t==='1'||/\\bconfirm|yes\\b/.test(t)) intent='CONFIRM';
else if (t==='2'||/resched|move|change/.test(t)) intent='RESCHEDULE';
else if (t==='3'||/cancel/.test(t)) intent='CANCEL';
else if (/late|minutes? late/.test(t)) intent='LATE';
return [{ json:{ intent } }];`});
  link(wf.connections,"Wait for Reply","Parse Intent");
  node(wf.nodes,"Update PMS (Mock)","n8n-nodes-base.function",[760,-20],{functionCode:`console.log('[PMS] schedule →', $json.intent); return items;`});
  link(wf.connections,"Parse Intent","Update PMS (Mock)");
  node(wf.nodes,"Fill Slot (Mock)","n8n-nodes-base.function",[1000,-20],{functionCode:
`if ($json.intent==='CANCEL'||$json.intent==='RESCHEDULE'){ console.log('[WAITLIST] backfill'); return [{json:{filled:true}}]; } return [{json:{skipped:true}}];`});
  link(wf.connections,"Update PMS (Mock)","Fill Slot (Mock)");
  return wf;
}
function wfBilling(s, industry){
  const modules = deriveModulesFromNarrative(s, industry);
  const wf = wfSkeleton(`${s.scenario_id} – ${s.agent_name || 'Billing Agent'} (Demo)`);
  node(wf.nodes,"Manual Trigger","n8n-nodes-base.manualTrigger",[-1460,-20],{});
  node(wf.nodes,"Design / Reasoning","n8n-nodes-base.function",[-1320,-160],{functionCode:`return [{ json:{ scenario_id:"${s.scenario_id}", modules:${JSON.stringify(modules)}, industry:${JSON.stringify(industry||null)} } }];`});
  wf.nodes.push(cfgNode(recommendedChannel(s)));
  link(wf.connections,"Manual Trigger","Design / Reasoning"); link(wf.connections,"Design / Reasoning","Set Config");
  node(wf.nodes,"Load Invoice","n8n-nodes-base.function",[-940,-20],{functionCode:`return [{ json:{ invoice:{ id:"INV-1047", amount:120.00, currency:"USD", due:"2025-10-03"}, debtor:{ name:"Alex", email:"alex@example.com", phone:"+15551230000"} } }];`});
  link(wf.connections,"Set Config","Load Invoice");
  const HOW=(s.how_it_works||'').replace(/`/g,'\\`'), ROI=(s.roi_hypothesis||'').replace(/`/g,'\\`'), PAI=(industry?.painpoints||'').replace(/`/g,'\\`');
  node(wf.nodes,"Compose Message","n8n-nodes-base.function",[-720,-20],{functionCode:
`const inv=$json.invoice, d=$json.debtor; const ctx=[\`${HOW}\`,\`${ROI}\`,\`${PAI}\`].filter(Boolean).join(' ');
return [{ json:{
  to:"kevanm.spain@gmail.com", toPhone:"+34XXXXXXXXX",
  subject:\`Invoice \${inv.id} due \${inv.due}\`,
  text:\`Hi \${d.name}, friendly reminder: invoice \${inv.id} for \${inv.amount} \${inv.currency} is due \${inv.due}.\${ctx?' '+ctx:''} Reply 1 PAID, 2 PLAN, 3 DISPUTE.\`,
  tts:"Invoice reminder."
}}];`});
  link(wf.connections,"Load Invoice","Compose Message");
  llmNodes(wf, buildLLMPrompt(s, industry, modules, 'billing'));
  branchChannels(wf, s);
  node(wf.nodes,"Wait for Reply","n8n-nodes-base.wait",[260,-20],{}); ["Email Send","Twilio SMS","Twilio WhatsApp","Twilio Call (TTS)"].forEach(n=>link(wf.connections,n,"Wait for Reply"));
  node(wf.nodes,"Parse Intent","n8n-nodes-base.function",[520,-20],{functionCode:
`const t=($json.Body||$json.text||"1").toLowerCase(); let intent='HUMAN';
if (t==='1'||/\\bpaid|settled|done\\b/.test(t)) intent='PAID';
else if (t==='2'||/plan|installment|payment plan/.test(t)) intent='PLAN';
else if (t==='3'||/dispute|error|wrong/.test(t)) intent='DISPUTE';
return [{ json:{ intent } }];`});
  link(wf.connections,"Wait for Reply","Parse Intent");
  node(wf.nodes,"Update AR (Mock)","n8n-nodes-base.function",[760,-20],{functionCode:`console.log('[AR] update →', $json.intent); return items;`});
  link(wf.connections,"Parse Intent","Update AR (Mock)");
  node(wf.nodes,"Follow-up (Mock)","n8n-nodes-base.function",[1000,-20],{functionCode:
`if ($json.intent==='PLAN') console.log('send plan options'); if ($json.intent==='DISPUTE') console.log('create ticket'); return items;`});
  link(wf.connections,"Update AR (Mock)","Follow-up (Mock)");
  return wf;
}
function wfLead(s, industry){
  const modules = deriveModulesFromNarrative(s, industry);
  const wf = wfSkeleton(`${s.scenario_id} – ${s.agent_name || 'Lead Agent'} (Demo)`);
  node(wf.nodes,"Manual Trigger","n8n-nodes-base.manualTrigger",[-1460,-20],{});
  node(wf.nodes,"Design / Reasoning","n8n-nodes-base.function",[-1320,-160],{functionCode:`return [{ json:{ scenario_id:"${s.scenario_id}", modules:${JSON.stringify(modules)}, industry:${JSON.stringify(industry||null)} } }];`});
  wf.nodes.push(cfgNode(recommendedChannel(s)));
  link(wf.connections,"Manual Trigger","Design / Reasoning"); link(wf.connections,"Design / Reasoning","Set Config");
  node(wf.nodes,"Load Lead","n8n-nodes-base.function",[-940,-20],{functionCode:`return [{ json:{ lead:{ name:"Jamie", email:"jamie@example.com", phone:"+15551234567", interest:"Implant consult"} } }];`});
  link(wf.connections,"Set Config","Load Lead");
  const HOW=(s.how_it_works||'').replace(/`/g,'\\`'), ROI=(s.roi_hypothesis||'').replace(/`/g,'\\`'), PAI=(industry?.painpoints||'').replace(/`/g,'\\`');
  node(wf.nodes,"Compose Message","n8n-nodes-base.function",[-720,-20],{functionCode:
`const L=$json.lead; const ctx=[\`${HOW}\`,\`${ROI}\`,\`${PAI}\`].filter(Boolean).join(' ');
return [{ json:{
  to:"kevanm.spain@gmail.com", toPhone:"+34XXXXXXXXX",
  subject:\`Thanks \${L.name} — quick questions\`,
  text:\`Hi \${L.name},\${ctx?' '+ctx:''} Are you available this week? Reply 1 THIS WEEK, 2 NEXT WEEK, 3 HUMAN.\`,
  tts:"Lead follow-up."
}}];`});
  link(wf.connections,"Load Lead","Compose Message");
  llmNodes(wf, buildLLMPrompt(s, industry, modules, 'lead'));
  branchChannels(wf, s);
  node(wf.nodes,"Wait for Reply","n8n-nodes-base.wait",[260,-20],{}); ["Email Send","Twilio SMS","Twilio WhatsApp","Twilio Call (TTS)"].forEach(n=>link(wf.connections,n,"Wait for Reply"));
  node(wf.nodes,"Parse Intent","n8n-nodes-base.function",[520,-20],{functionCode:
`const t=($json.Body||$json.text||"1").toLowerCase(); let intent='THIS_WEEK';
if (t==='2'||/next/.test(t)) intent='NEXT_WEEK';
else if (t==='3'||/human|agent|call me/.test(t)) intent='HUMAN';
return [{ json:{ intent } }];`});
  link(wf.connections,"Wait for Reply","Parse Intent");
  node(wf.nodes,"Route (Mock)","n8n-nodes-base.function",[760,-20],{functionCode:`console.log('[CRM] route →', $json.intent); return items;`});
  link(wf.connections,"Parse Intent","Route (Mock)");
  return wf;
}
function buildWorkflowJSON(s) {
  const industry = matchIndustryForScenario(s);
  const key = pickTemplate(s, industry);
  if (key==='billing') return wfBilling(s, industry);
  if (key==='lead')    return wfLead(s, industry);
  return wfScheduling(s, industry);
}

/* ---------- download ---------- */
function downloadJSON(obj, filename){
  const txt=JSON.stringify(obj,null,2);
  const blob=new Blob([txt],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}
$('build').addEventListener('click', () => {
  const sid = (scenarioSel.value || '').trim(); const s = MAP[sid];
  if (!s) { dbg.textContent='No scenario selected'; return; }
  const wf = buildWorkflowJSON(s);
  downloadJSON(wf, `${sid}-workflow.json`);
});

/* ---------- go ---------- */
bootstrap();
</script>
</body>
</html>
