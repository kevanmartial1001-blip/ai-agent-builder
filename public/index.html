<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Agent Builder</title>
<style>
  :root{--bg:#0b0c10;--card:#141824;--ink:#e9edf1;--muted:#9aa6b2;--accent:#5eead4;--line:#232735}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:32px auto;padding:0 20px}
  h1{margin:0 0 16px;font-size:26px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin:12px 0 6px}
  select,textarea,input,button{width:100%;background:#0f1218;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  textarea{min-height:220px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px}
  button{cursor:pointer} .primary{background:var(--accent);color:#0b0c10;border:none;font-weight:700}
  .hint{color:var(--muted);font-size:13px}
  #suggestions{position:relative}
  .suggest-box{position:absolute;left:0;right:0;background:#0f1218;border:1px solid var(--line);border-radius:10px;margin-top:6px;max-height:260px;overflow:auto;z-index:10}
  .suggest-item{padding:8px 10px;cursor:pointer;display:flex;gap:8px;align-items:baseline}
  .suggest-item:hover{background:#121826}
  .suggest-id{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
  .suggest-name{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dbg{font:12px/1.4 ui-monospace,Consolas,monospace;color:#aaa;margin-top:8px;word-break:break-word}
  .err{color:#fca5a5}
  .ok{color:#5eead4}
  .row-actions{display:flex;gap:12px;align-items:center;margin-top:10px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0f1218}
  .btn.primary{background:var(--accent);border:none;color:#0b0c10;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .inline{display:inline-block;margin-left:8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Agent Builder</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="scenario">Scenario (<code>scenario_id</code>)</label>
        <select id="scenario"><option value="">Loading…</option></select>
      </div>
      <div>
        <label for="channel">Channel (auto)</label>
        <select id="channel">
          <option value="email">Email</option>
          <option value="sms">SMS (Twilio)</option>
          <option value="whatsapp">WhatsApp (Twilio)</option>
          <option value="call">Voice Call (Twilio)</option>
        </select>
      </div>
    </div>

    <label for="search">Search the full catalog (8k+)</label>
    <input id="search" placeholder="Type scenario_id or name…  e.g. tier1_dso_SCHEDULING_NO_SHOWS" autocomplete="off" />
    <div id="suggestions"></div>

    <label for="bp">Preview (JSON)</label>
    <textarea id="bp" readonly></textarea>

    <div class="row-actions">
      <button id="create" class="btn primary">Create Workflow (AI)</button>
      <button id="download" class="btn" disabled>Download n8n JSON</button>
      <span class="inline" id="modeNote">Builder: <b>Server /api/build</b> (<code>compat=safe</code>)</span>
    </div>
    <div class="hint">Imports directly in n8n. Tip: toggle full nodes with <code>?compat=full</code> or force local builder with <code>?local=1</code>.</div>
    <div id="dbg" class="dbg"></div>
  </div>
</div>

<!-- Load local builder as fallback (no defer/async). Keep version bump for cache busting. -->
<script src="/builder.js?v=24-finalize-sanitize"></script>

<script>
/* ========== Small helpers ========== */
const $ = id => document.getElementById(id);
const scenarioSel = $('scenario'), channelSel = $('channel'),
      searchEl = $('search'), suggestWrap = $('suggestions'), bpTA = $('bp'),
      dbg = $('dbg'), btnCreate = $('create'), btnDownload = $('download'), modeNote = $('modeNote');

let ALL = [], MAP = {}, LAST_WF = null, LAST_SID = '';
let INDUSTRIES = [], IND_MAP = {};

const QS = new URLSearchParams(location.search);
const compat = (QS.get('compat') || 'safe').toLowerCase() === 'full' ? 'full' : 'safe';
const forceLocal = (QS.get('local') || '0') === '1';
modeNote.innerHTML = `Builder: <b>${forceLocal?'Local /builder.js':'Server /api/build'}</b> (<code>compat=${compat}</code>)`;

function listify(v){ return Array.isArray(v) ? v : String(v ?? '')
  .replace(/^\[|\]$/g,'')
  .split(/[;,|\n|\|,]+/)
  .map(x=>x.replace(/^['"]|['"]$/g,'').trim())
  .filter(Boolean); }

async function getJSON(url){
  const r = await fetch(url, { cache:'no-store' });
  const raw = await r.text();
  try { return { ok:r.ok, status:r.status, json: JSON.parse(raw), raw }; }
  catch { return { ok:r.ok, status:r.status, json:null, raw }; }
}
async function postJSON(url, body){
  const r = await fetch(url, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(body||{}),
  });
  const text = await r.text();
  let json = null;
  try { json = JSON.parse(text); } catch {}
  return { ok:r.ok, status:r.status, json, raw:text, headers:r.headers };
}

function recommendedChannel(row){
  const shapes = listify(row.best_reply_shapes).map(x=>x.toLowerCase());
  const set = new Set(shapes.map(s =>
    s.includes('whatsapp')?'whatsapp':
    (s.includes('sms')||s.includes('text'))?'sms':
    (s.includes('voice')||s.includes('call'))?'call':
    s.includes('email')?'email':s));
  if (set.has('sms')) return 'sms';
  if (set.has('whatsapp')) return 'whatsapp';
  if (set.has('email')) return 'email';
  if (set.has('call')) return 'call';
  return 'email';
}
function matchIndustryForScenario(s){
  const key = (s.name||'').toLowerCase();
  return IND_MAP[key] || null;
}

/* ========== UI populate + actions ========== */
function populateUI(list){
  scenarioSel.innerHTML = '';
  const frag = document.createDocumentFragment();
  list.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.scenario_id; o.textContent=s.scenario_id; o.title=s.name||s.scenario_id;
    frag.appendChild(o);
  });
  scenarioSel.appendChild(frag);
  if (list.length) applyScenario(list[0].scenario_id);
}
function applyScenario(id){
  const s = MAP[id] || ALL.find(x=>x.scenario_id===id) || null;
  if (!s) return;
  const industry = matchIndustryForScenario(s);
  scenarioSel.value = s.scenario_id;
  channelSel.value  = recommendedChannel(s);
  LAST_WF = null; LAST_SID = s.scenario_id;
  bpTA.value = JSON.stringify({ note:"Click 'Create Workflow (AI)' to build a per-scenario workflow on the server.", scenario_id:s.scenario_id }, null, 2);
  btnDownload.disabled = true;
}

/* ========== Remote search across 8k+ ========== */
let searchTimer = null;
async function remoteSearch(q){
  if (!q || q.trim().length < 2){ suggestWrap.innerHTML=''; return; }
  const url = `/api/scenarios?q=${encodeURIComponent(q)}&limit=50`;
  const res = await getJSON(url);
  const items = (res.ok && res.json && Array.isArray(res.json.items)) ? res.json.items : [];
  renderSuggestions(items);
}
function renderSuggestions(matches){
  if (!matches || !matches.length){ suggestWrap.innerHTML=''; return; }
  const box = document.createElement('div'); box.className='suggest-box';
  box.innerHTML = matches.map(m=>{
    const id=(m.scenario_id||'').replace(/</g,'&lt;');
    const nm=(m.name||'').replace(/</g,'&lt;');
    return `<div class="suggest-item" data-id="${id}">
        <span class="suggest-id">${id}</span>
        <span class="suggest-name">${nm}</span>
      </div>`;
  }).join('');
  box.addEventListener('click', (e)=>{
    const el = e.target.closest('.suggest-item'); if(!el) return;
    const id = el.getAttribute('data-id');
    if (!MAP[id]){
      const m = matches.find(x=>x.scenario_id===id);
      if (m){
        MAP[id] = {
          scenario_id: m.scenario_id||'',
          name: m.name||'',
          triggers: m.triggers||'',
          best_reply_shapes: listify(m.best_reply_shapes),
          risk_notes: m.risk_notes||'',
          agent_name: m.agent_name||'',
          how_it_works: m.how_it_works||'',
          tool_stack_dev: m.tool_stack_dev||'',
          tool_stack_autonomous: m.tool_stack_autonomous||'',
          tags: listify(m.tags||m['tags (;)']||'')
        };
      }
    }
    $('search').value = id;
    applyScenario(id);
    suggestWrap.innerHTML='';
  });
  suggestWrap.innerHTML=''; suggestWrap.appendChild(box);
}
searchEl.addEventListener('input', e=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>remoteSearch(e.target.value), 180);
});
searchEl.addEventListener('focus', ()=> {
  if (ALL.length) renderSuggestions(ALL.slice(0,10));
});
searchEl.addEventListener('blur', ()=> setTimeout(()=>suggestWrap.innerHTML='',150));
searchEl.addEventListener('keydown', e=>{
  if (e.key==='Enter'){
    const v = e.target.value.trim();
    if (MAP[v]){ applyScenario(v); suggestWrap.innerHTML=''; return; }
    // If user typed an exact scenario_id not in cache, still allow selection
    scenarioSel.value = v; LAST_SID = v; LAST_WF = null; btnDownload.disabled = true;
    bpTA.value = JSON.stringify({ note:"Press 'Create Workflow (AI)' to build on the server.", scenario_id:v }, null, 2);
    remoteSearch(v);
  }
});
scenarioSel.addEventListener('change', ()=> applyScenario(scenarioSel.value));
channelSel.addEventListener('change', ()=> {/* keep for future live preview */});

/* ========== Create via /api/build (primary) ========== */
async function createViaServer(sid){
  dbg.innerHTML = 'Building on server…';
  btnCreate.disabled = true;
  const payload = {
    scenario_id: sid,
    compat,               // 'safe' | 'full'
    includeDemo: true,    // always include the demo lane
    forceArchetype: null, // leave null; server will choose from rules unless you pass one
  };
  const r = await postJSON('/api/build', payload);
  btnCreate.disabled = false;

  if (!r.ok) {
    dbg.innerHTML = `<span class="err">Server build error (${r.status}):</span> ${r.raw || 'unknown'}`;
    return null;
  }
  // Some setups return the JSON as raw text (attachment). Try json then fallback parse.
  let wf = r.json;
  if (!wf) {
    try { wf = JSON.parse(r.raw); } catch (e) {}
  }
  if (!wf || !wf.nodes) {
    dbg.innerHTML = `<span class="err">Build returned no workflow JSON.</span>`;
    return null;
  }
  dbg.innerHTML = `<span class="ok">Built on server.</span> Nodes: ${wf.nodes.length}`;
  return wf;
}

/* ========== Local fallback (optional) ========== */
function hasLocalBuilder(){
  return window.Builder && typeof window.Builder.buildWorkflowJSON === 'function';
}
function buildLocal(sid){
  const s = MAP[sid] || { scenario_id: sid, name: sid, agent_name: 'Agent', best_reply_shapes: ['email'] };
  const ind = matchIndustryForScenario(s);
  try {
    const wf = window.Builder.buildWorkflowJSON(s, ind, { recommendedChannel: channelSel.value });
    dbg.innerHTML = `<span class="ok">Built locally.</span> Nodes: ${wf.nodes?.length||0}`;
    return wf;
  } catch (e) {
    dbg.innerHTML = `<span class="err">Local builder error:</span> ${e.message||String(e)}`;
    return null;
  }
}

/* ========== Buttons ========== */
btnCreate.addEventListener('click', async ()=>{
  const sid = (scenarioSel.value || searchEl.value || '').trim();
  if (!sid){ dbg.innerHTML = '<span class="err">Select or type a scenario_id first.</span>'; return; }
  LAST_SID = sid;

  let wf = null;
  if (!forceLocal){
    wf = await createViaServer(sid);
  }
  if (!wf && hasLocalBuilder()){
    wf = buildLocal(sid);
  }
  if (!wf){
    bpTA.value = '// Build failed. See debug below.';
    btnDownload.disabled = true;
    return;
  }
  LAST_WF = wf;
  bpTA.value = JSON.stringify(wf, null, 2);
  btnDownload.disabled = false;
});

btnDownload.addEventListener('click', ()=>{
  if (!LAST_WF){ dbg.innerHTML = '<span class="err">Nothing to download. Click Create first.</span>'; return; }
  const txt=JSON.stringify(LAST_WF,null,2);
  const blob=new Blob([txt],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`${(LAST_SID||'workflow')}.n8n.json`;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
});

/* ========== Bootstrap (25 initial + industries) ========== */
async function bootstrap(){
  try{
    const [sc, ind] = await Promise.all([
      getJSON('/api/scenarios?cursor=0&limit=25'),
      getJSON('/api/industries'),
    ]);
    const sitems = (sc.ok && sc.json && Array.isArray(sc.json.items)) ? sc.json.items : [];
    const iitems = (ind.ok && ind.json && Array.isArray(ind.json.items)) ? ind.json.items : [];

    ALL = sitems.map(x=>({
      scenario_id:x.scenario_id||'',
      name:x.name||'',
      triggers:x.triggers||'',
      best_reply_shapes:listify(x.best_reply_shapes),
      risk_notes:x.risk_notes||'',
      agent_name:x.agent_name||'',
      how_it_works:x.how_it_works||'',
      tool_stack_dev:x.tool_stack_dev||'',
      tool_stack_autonomous:x.tool_stack_autonomous||'',
      tags:listify(x.tags||x['tags (;)']||'')
    })).filter(s=>s.scenario_id);
    MAP = Object.fromEntries(ALL.map(x=>[x.scenario_id,x]));

    INDUSTRIES = iitems.map(it=>({
      industry_id:it.industry_id||it.name||'',
      name: it.name || it.industry_id || '',
      painpoints:it.core_pains||it.painpoints||'',
      kpis:it.success_metrics||it.kpi_examples||'',
      channels:it.channels||it.core_channels||'',
      vocabulary:it.agent_language_prompt||''
    })).filter(i=>i.industry_id);
    IND_MAP = Object.fromEntries(INDUSTRIES.map(it=>[(it.industry_id||'').toLowerCase(), it]));

    if (!ALL.length){
      const fallbackS={scenario_id:'tier1_dso_SCHEDULING_NO_SHOWS',name:'tier1_dso',agent_name:'Scheduling Agent',best_reply_shapes:['sms','email'],how_it_works:'Remind, confirm, backfill.',roi_hypothesis:'Reduce no-shows 30%+'};
      const fallbackI={industry_id:'tier1_dso',name:'tier1_dso',painpoints:'no-shows; front-desk overload',kpis:'no-show rate; utilization'};
      ALL=[fallbackS]; MAP={ [fallbackS.scenario_id]: fallbackS };
      INDUSTRIES=[fallbackI]; IND_MAP={ [fallbackI.industry_id]: fallbackI };
    }
    populateUI(ALL);
    dbg.textContent = 'Ready.';
  } catch (e){
    dbg.innerHTML = '<span class="err">Bootstrap error:</span> ' + (e.message||String(e));
    const fallbackS={scenario_id:'tier1_dso_SCHEDULING_NO_SHOWS',name:'tier1_dso',agent_name:'Scheduling Agent',best_reply_shapes:['sms','email']};
    const fallbackI={industry_id:'tier1_dso',name:'tier1_dso'};
    ALL=[fallbackS]; MAP={ [fallbackS.scenario_id]: fallbackS };
    INDUSTRIES=[fallbackI]; IND_MAP={ [fallbackI.industry_id]: fallbackI };
    populateUI(ALL);
  }
}
bootstrap();
</script>
</body>
</html>
