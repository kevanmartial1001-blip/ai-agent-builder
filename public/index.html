<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Agent Builder</title>
  <style>
    :root{--bg:#0b0c10;--card:#141824;--ink:#e9edf1;--muted:#9aa6b2;--accent:#5eead4;--line:#232735}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1080px;margin:28px auto;padding:0 20px}
    h1{font-size:26px;margin:0 0 8px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    select,input,button,textarea{background:#0f1320;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    button{background:var(--accent);color:#051016;border:none;cursor:pointer;font-weight:600}
    button[disabled]{opacity:.6;cursor:not-allowed}
    label{color:var(--muted);font-size:13px}
    pre{white-space:pre-wrap;word-break:break-word;max-height:60vh;overflow:auto;margin:0}
    .muted{color:var(--muted)}
    .badge{display:inline-block;background:#0f1320;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AI Agent → n8n Workflow Builder <span class="badge">v9</span></h1>
    <div class="card">
      <div class="row">
        <div>
          <label>Industry</label><br/>
          <select id="industrySelect"></select>
        </div>
        <div>
          <label>Scenario</label><br/>
          <select id="scenarioSelect" style="min-width:320px"></select>
        </div>
        <div>
          <label>Recommended channel</label><br/>
          <select id="channelSelect">
            <option value="email">Email</option>
            <option value="sms">SMS</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="call">Call</option>
          </select>
        </div>
        <div style="align-self:end; margin-bottom: -2px;">
          <button id="btnBuild">Build JSON</button>
          <button id="btnDownload" disabled>Download n8n JSON</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><strong>Preview</strong> (JSON)</div>
        <div class="muted">If you see YAML here, the Builder didn’t load.</div>
      </div>
      <pre id="preview">Loading…</pre>
    </div>

    <p class="muted">
      Tip: If you ever see “Builder not loaded…”, force a cache bust by changing the query in the script tag (e.g. <code>?v=10</code>) and do a hard refresh (Ctrl/Cmd+Shift+R).
    </p>
  </div>

  <!-- Load the builder with cache-busting; no defer/async so it executes before the inline script below -->
  <script src="/builder.js?v=9"></script>

  <script>
    (function () {
      const $industry = document.getElementById('industrySelect');
      const $scenario = document.getElementById('scenarioSelect');
      const $channel  = document.getElementById('channelSelect');
      const $preview  = document.getElementById('preview');
      const $btnBuild = document.getElementById('btnBuild');
      const $btnDl    = document.getElementById('btnDownload');

      // Guard: verify global is present synchronously
      function assertBuilder() {
        if (!window.Builder || typeof window.Builder.buildWorkflowJSON !== 'function') {
          throw new Error('Builder not loaded (using YAML in preview only). Check /public/builder.js and the script tag order.');
        }
      }

      async function fetchJSON(path) {
        const res = await fetch(path, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Failed to fetch ${path}: ${res.status}`);
        return res.json();
      }

      function populateIndustries(list) {
        $industry.innerHTML = '';
        list.forEach((ind, i) => {
          const opt = document.createElement('option');
          opt.value = ind.industry_id || ind.id || ind.slug || String(i);
          opt.textContent = ind.name || ind.title || opt.value;
          opt.dataset.payload = JSON.stringify(ind);
          $industry.appendChild(opt);
        });
      }

      function populateScenarios(list) {
        $scenario.innerHTML = '';
        list.forEach((s, i) => {
          const opt = document.createElement('option');
          opt.value = s.scenario_id || s.id || String(i);
          opt.textContent = s.agent_name ? `${s.agent_name} — ${s.scenario_id || s.id}` : (s.title || opt.value);
          opt.dataset.payload = JSON.stringify(s);
          $scenario.appendChild(opt);
        });
      }

      function currentIndustry() {
        const opt = $industry.selectedOptions[0];
        return opt ? JSON.parse(opt.dataset.payload) : null;
      }
      function currentScenario() {
        const opt = $scenario.selectedOptions[0];
        return opt ? JSON.parse(opt.dataset.payload) : null;
      }

      async function init() {
        try {
          assertBuilder();
        } catch (e) {
          // Show YAML fallback only if builder truly missing
          $preview.textContent = 'Builder not loaded (using YAML in preview only). Check /builder.js.';
          console.warn(e);
        }

        const [industries, scenarios] = await Promise.all([
          fetchJSON('/api/industries'),
          fetchJSON('/api/scenarios')
        ]);

        populateIndustries(industries);
        populateScenarios(scenarios);

        // Initial preview
        buildAndPreview();
      }

      function buildAndPreview() {
        try {
          assertBuilder();
          const s = currentScenario();
          const ind = currentIndustry();
          const channel = $channel.value;
          const wf = window.Builder.buildWorkflowJSON(s, ind, { recommendedChannel: channel });

          const pretty = JSON.stringify(wf, null, 2);
          $preview.textContent = pretty;
          $btnDl.disabled = false;

          // Bind download
          $btnDl.onclick = () => {
            const blob = new Blob([pretty], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const name = (s?.scenario_id || 'workflow').replace(/[^a-z0-9_\-]+/gi,'_');
            a.href = url;
            a.download = `${name}.n8n.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          };
        } catch (err) {
          // Fallback message
          $preview.textContent = 'Builder not loaded (using YAML in preview only). Check /builder.js.';
          $btnDl.disabled = true;
          console.error(err);
        }
      }

      $btnBuild.addEventListener('click', buildAndPreview);
      $industry.addEventListener('change', buildAndPreview);
      $scenario.addEventListener('change', buildAndPreview);
      $channel.addEventListener('change', buildAndPreview);

      init().catch(err => {
        $preview.textContent = String(err);
      });
    })();
  </script>
</body>
</html>
