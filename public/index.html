<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Agent Builder</title>
<style>
  :root{--bg:#0b0c10;--card:#141824;--ink:#e9edf1;--muted:#9aa6b2;--accent:#5eead4;--line:#232735}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:32px auto;padding:0 20px}
  h1{margin:0 0 16px;font-size:26px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin:12px 0 6px}
  select,textarea,input,button{width:100%;background:#0f1218;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  textarea{min-height:260px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px}
  button{cursor:pointer} .primary{background:var(--accent);color:#0b0c10;border:none;font-weight:700}
  .hint{color:var(--muted);font-size:13px}
  #suggestions{position:relative}
  .suggest-box{position:absolute;left:0;right:0;background:#0f1218;border:1px solid var(--line);border-radius:10px;margin-top:6px;max-height:260px;overflow:auto;z-index:10}
  .suggest-item{padding:8px 10px;cursor:pointer;display:flex;gap:8px;align-items:baseline}
  .suggest-item:hover{background:#121826}
  .suggest-id{font-family:ui-monospace,Consolas,Menlo,monospace;font-size:12px}
  .suggest-name{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dbg{font:12px/1.4 ui-monospace,Consolas,monospace;color:#aaa;margin-top:8px;word-break:break-word}
  .err{color:#fca5a5}
  .ok{color:#34d399}
</style>
</head>
<body>
<div class="wrap">
  <h1>AI Agent Builder</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="scenario">Scenario (<code>scenario_id</code>)</label>
        <select id="scenario"><option value="">Loading…</option></select>
      </div>
      <div>
        <label for="channel">Channel (auto)</label>
        <select id="channel">
          <option value="email">Email</option>
          <option value="sms">SMS (Twilio)</option>
          <option value="whatsapp">WhatsApp (Twilio)</option>
          <option value="call">Voice Call (Twilio)</option>
        </select>
      </div>
    </div>

    <label for="search">Search the full catalog (8k+)</label>
    <input id="search" placeholder="Type scenario_id or name…  e.g. tier1_dso_SCHEDULING_NO_SHOWS" autocomplete="off" />
    <div id="suggestions"></div>

    <label for="bp">Preview (JSON)</label>
    <textarea id="bp" readonly></textarea>

    <div class="row" style="margin-top:10px">
      <button id="build" class="primary">Download n8n JSON</button>
      <div class="hint">Imports directly in n8n (Prod + Demo lanes)</div>
    </div>
    <div id="dbg" class="dbg"></div>
  </div>
</div>

<!-- Keep the client builder as fallback only; no defer/async; bump v= to bust cache. -->
<script src="/builder.js?v=23-api-preview-fallback"></script>

<script>
/* ========== Small helpers ========== */
const $ = id => document.getElementById(id);
const scenarioSel = $('scenario'), channelSel = $('channel'),
      searchEl = $('search'), suggestWrap = $('suggestions'), bpTA = $('bp'),
      dbg = $('dbg');

let ALL = [], MAP = {};
let INDUSTRIES = [], IND_MAP = {};

function listify(v){ return Array.isArray(v) ? v : String(v ?? '')
  .replace(/^\[|\]$/g,'')
  .split(/[;,|\n|\|,]+/)
  .map(x=>x.replace(/^['"]|['"]$/g,'').trim())
  .filter(Boolean); }

async function getJSON(url){
  const r = await fetch(url, { cache:'no-store' });
  const raw = await r.text();
  try { return { ok:r.ok, status:r.status, json: JSON.parse(raw), raw }; }
  catch { return { ok:r.ok, status:r.status, json:null, raw }; }
}

function recommendedChannel(row){
  const shapes = listify(row.best_reply_shapes).map(x=>x.toLowerCase());
  const set = new Set(shapes.map(s =>
    s.includes('whatsapp')?'whatsapp':
    (s.includes('sms')||s.includes('text'))?'sms':
    (s.includes('voice')||s.includes('call'))?'call':
    s.includes('email')?'email':s));
  if (set.has('sms')) return 'sms';
  if (set.has('whatsapp')) return 'whatsapp';
  if (set.has('email')) return 'email';
  if (set.has('call')) return 'call';
  return 'email';
}
function matchIndustryForScenario(s){
  const key = (s.name||'').toLowerCase();
  return IND_MAP[key] || null;
}

/* ========= /api/build driver (LLM) with local fallback ========= */
async function buildViaApi(scenarioId, compat = 'safe', includeDemo = true) {
  const res = await fetch(`/api/build?preview=1`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Preview': '1',
      'Cache-Control': 'no-store'
    },
    body: JSON.stringify({ scenario_id: scenarioId, compat, includeDemo })
  });
  if (!res.ok) {
    const t = await res.text();
    throw new Error(`api/build failed: ${res.status} ${res.statusText} — ${t}`);
  }
  return res.json();
}

function assertBuilder(){
  if (!window.Builder || typeof window.Builder.buildWorkflowJSON !== 'function') {
    throw new Error('Builder not loaded (check /public/builder.js and the script tag order).');
  }
}

async function rebuildPreview() {
  const sid = (scenarioSel.value || '').trim();
  // We can call /api/build even if MAP doesn't have the row (the API hits Sheets directly).
  if (!sid) {
    dbg.innerHTML = '<span class="err">No scenario selected.</span>';
    return;
  }

  try {
    // Prefer the API (LLM) result for preview
    const wf = await buildViaApi(sid, 'safe', true);
    bpTA.value = JSON.stringify(wf, null, 2);
    dbg.innerHTML = '<span class="ok">Preview: using /api/build (LLM)</span>';
    window.__lastWorkflow = wf;
    window.__lastScenarioId = sid;
  } catch (e) {
    // Fallback to local builder
    try {
      assertBuilder();
      const s = MAP[sid] || { scenario_id: sid, name: sid, agent_name: 'Agent' };
      const wf = window.Builder.buildWorkflowJSON(s, matchIndustryForScenario(s), {
        recommendedChannel: channelSel.value
      });
      bpTA.value = JSON.stringify(wf, null, 2);
      window.__lastWorkflow = wf;
      window.__lastScenarioId = sid;
      dbg.innerHTML =
        '<span class="err">/api/build failed, using local builder fallback.</span><br/>' +
        (e && e.message ? e.message : String(e));
    } catch (e2) {
      dbg.innerHTML =
        '<span class="err">Both /api/build and local builder failed.</span><br/>' +
        (e2 && e2.message ? e2.message : String(e2));
    }
  }
}

/* ========== UI populate + actions ========== */
function populateUI(list){
  scenarioSel.innerHTML = '';
  const frag = document.createDocumentFragment();
  list.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.scenario_id; o.textContent=s.scenario_id; o.title=s.name||s.scenario_id;
    frag.appendChild(o);
  });
  scenarioSel.appendChild(frag);
  if (list.length) {
    scenarioSel.value = list[0].scenario_id;
    channelSel.value  = recommendedChannel(list[0]);
    rebuildPreview();
  }
}

let searchTimer = null;
async function remoteSearch(q){
  if (!q || q.trim().length < 2){ suggestWrap.innerHTML=''; return; }
  const url = `/api/scenarios?q=${encodeURIComponent(q)}&limit=50`;
  const res = await getJSON(url);
  const items = (res.ok && res.json && Array.isArray(res.json.items)) ? res.json.items : [];
  renderSuggestions(items);
}
function renderSuggestions(matches){
  if (!matches || !matches.length){ suggestWrap.innerHTML=''; return; }
  const box = document.createElement('div'); box.className='suggest-box';
  box.innerHTML = matches.map(m=>{
    const id=(m.scenario_id||'').replace(/</g,'&lt;');
    const nm=(m.name||'').replace(/</g,'&lt;');
    return `<div class="suggest-item" data-id="${id}">
        <span class="suggest-id">${id}</span>
        <span class="suggest-name">${nm}</span>
      </div>`;
  }).join('');
  box.addEventListener('click', (e)=>{
    const el = e.target.closest('.suggest-item'); if(!el) return;
    const id = el.getAttribute('data-id');
    if (!MAP[id]){
      const m = matches.find(x=>x.scenario_id===id);
      if (m){
        MAP[id] = {
          scenario_id: m.scenario_id||'',
          name: m.name||'',
          triggers: m.triggers||'',
          best_reply_shapes: listify(m.best_reply_shapes),
          risk_notes: m.risk_notes||'',
          agent_name: m.agent_name||'',
          how_it_works: m.how_it_works||'',
          tool_stack_dev: m.tool_stack_dev||'',
          tool_stack_autonomous: m.tool_stack_autonomous||'',
          tags: listify(m.tags||m['tags (;)']||'')
        };
      }
    }
    $('search').value = id;
    scenarioSel.value = id;
    channelSel.value = recommendedChannel(MAP[id] || {});
    suggestWrap.innerHTML='';
    rebuildPreview();
  });
  suggestWrap.innerHTML=''; suggestWrap.appendChild(box);
}
searchEl.addEventListener('input', e=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=>remoteSearch(e.target.value), 180);
});
searchEl.addEventListener('focus', ()=> {
  if (ALL.length) renderSuggestions(ALL.slice(0,10));
});
searchEl.addEventListener('blur', ()=> setTimeout(()=>suggestWrap.innerHTML='',150));
searchEl.addEventListener('keydown', e=>{
  if (e.key==='Enter'){
    const v = e.target.value.trim();
    // Let the API handle unknown IDs too
    scenarioSel.value = v;
    rebuildPreview();
  }
});
scenarioSel.addEventListener('change', rebuildPreview);
channelSel.addEventListener('change', rebuildPreview);

/* ========== Download uses last previewed workflow ========== */
function downloadJSON(obj, filename){
  const txt=JSON.stringify(obj,null,2);
  const blob=new Blob([txt],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}
$('build').addEventListener('click', ()=>{
  const wf = window.__lastWorkflow;
  const sid = window.__lastScenarioId || (scenarioSel.value||'workflow');
  if (!wf) { dbg.innerHTML = '<span class="err">Nothing to download. Build failed?</span>'; return; }
  downloadJSON(wf, `${sid}.n8n.json`);
});

/* ========== Bootstrap (25 initial, search does the rest) ========== */
async function bootstrap(){
  try{
    const [sc, ind] = await Promise.all([
      getJSON('/api/scenarios?cursor=0&limit=25'),
      getJSON('/api/industries'),
    ]);
    const sitems = (sc.ok && sc.json && Array.isArray(sc.json.items)) ? sc.json.items : [];
    const iitems = (ind.ok && ind.json && Array.isArray(ind.json.items)) ? ind.json.items : [];

    ALL = sitems.map(x=>({
      scenario_id:x.scenario_id||'',
      name:x.name||'',
      triggers:x.triggers||'',
      best_reply_shapes:listify(x.best_reply_shapes),
      risk_notes:x.risk_notes||'',
      agent_name:x.agent_name||'',
      how_it_works:x.how_it_works||'',
      tool_stack_dev:x.tool_stack_dev||'',
      tool_stack_autonomous:x.tool_stack_autonomous||'',
      tags:listify(x.tags||x['tags (;)']||'')
    })).filter(s=>s.scenario_id);
    MAP = Object.fromEntries(ALL.map(x=>[x.scenario_id,x]));

    INDUSTRIES = iitems.map(it=>({
      industry_id:it.industry_id||it.name||'',
      painpoints:it.core_pains||it.painpoints||'',
      kpis:it.success_metrics||it.kpi_examples||'',
      channels:it.channels||it.core_channels||'',
      vocabulary:it.agent_language_prompt||''
    })).filter(i=>i.industry_id);
    IND_MAP = Object.fromEntries(INDUSTRIES.map(it=>[(it.industry_id||'').toLowerCase(), it]));

    populateUI(ALL);
  } catch (e){
    dbg.innerHTML = '<span class="err">Bootstrap error:</span> ' + (e.message||String(e));
    // Minimal fallback so the UI still runs
    const fallbackS={scenario_id:'tier1_dso_SCHEDULING_NO_SHOWS',name:'tier1_dso',agent_name:'Scheduling Agent',best_reply_shapes:['sms','email'],how_it_works:'Remind, confirm, backfill.',roi_hypothesis:'Reduce no-shows 30%+'};
    const fallbackI={industry_id:'tier1_dso',painpoints:'no-shows; front-desk overload',kpis:'no-show rate; utilization'};
    ALL=[fallbackS]; MAP={ [fallbackS.scenario_id]: fallbackS };
    INDUSTRIES=[fallbackI]; IND_MAP={ [fallbackI.industry_id]: fallbackI };
    populateUI(ALL);
  }
}
bootstrap();
</script>
</body>
</html>
